#!/usr/bin/env bash

set -e

BUILD_DIR=$1

# We get passed these other things, but we don't really need them.

#CACHE_DIR=$2
#ENV_DIR=$3

#BIN_DIR=$(cd $(dirname $0); pwd)
#BUILDPACK_DIR=$(dirname $BIN_DIR)

file="$BUILD_DIR/Sluggerator"

if [ ! -f "$file" ]; then
  file="$BUILD_DIR/.slugignore"
fi

if [ ! -f "$file" ]; then
  echo "I don't know how you got here, but exiting because we can't find a suitable Sluggerator or .slugignore file!"
  exit 0
fi

#echo "BUILD_DIR is $BUILD_DIR"
echo "Sluggerating with $file"

killfile () {
  if [[ -z "$DRY_RUN" ]]; then
    echo "REAL: rm -f $1"
    rm -f $1
  else
    echo "DRY: rm -f $1"
  fi
}

killdir () {
  if [[ -z "$DRY_RUN" ]]; then
#    echo "REAL: rm -rf $1"
    rm -rf $1
  else
    echo "DRY: rm -rf $1"
  fi
}

while read -r line; do
#  echo "Trying to sluggerate $line"

  if [[ $line =~ ^\s*#.*$ ]] || [[ -z "$line" ]]; then
#    echo "Skipping $line"
    continue
  fi

  sluggy="$(ls -1d $line 2>/dev/null || echo '')"

#  echo "sluggy is $sluggy"

  tf="$(mktemp)"

  echo "$sluggy" > $tf

  while read -r line_item; do
#    echo "line_item is $line_item"

    if [[ -f "$line_item" ]]; then
      killfile $line_item
    elif [[ -d "$line_item" ]]; then
      killdir $line_item
    else
      echo "Unknown thing to sluggerate: $line"
    fi
  done < $tf
done < $file
